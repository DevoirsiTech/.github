name: Documentation Generation

on:
  repository_dispatch:
    types: [docs-update]
  workflow_dispatch:
    inputs:
      projects:
        description: 'Projects to generate docs for (backend,fileserver,frontend or all)'
        required: false
        default: 'all'

jobs:
  generate-docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: write
      repository-projects: read
      actions: read
    
    steps:
    - name: ğŸ“¥ Clone docs repository manually
      run: |
        git clone https://x-access-token:${{ secrets.DOCS_TOKEN }}@github.com/DevoirsiTech/devoirsitech-doc.git docs-repo
        cd docs-repo
        git config user.name 'Documentation Bot'
        git config user.email 'noreply@devoirsitech.com'
        
    - name: ğŸ› ï¸ Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'
        
    - name: ğŸ› ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ğŸ“¦ Install DocFX
      run: dotnet tool install --global docfx --version 2.75.3
      
    - name: ğŸ“š Generate Backend Documentation
      if: contains(github.event.inputs.projects, 'backend') || contains(github.event.inputs.projects, 'all') || github.event_name == 'repository_dispatch'
      run: |
        # Clone backend repo avec token pour accÃ¨s privÃ©
        git clone https://x-access-token:${{ secrets.DOCS_TOKEN }}@github.com/DevoirsiTech/devoirsitech-backend.git temp-backend
        cd temp-backend
        
        # Build project to generate XML docs
        dotnet restore
        dotnet build --configuration Release
        
        # Generate documentation with DocFX
        docfx docfx.json --serve false
        
        # Copy to docs repo
        mkdir -p ../docs-repo/generated/backend
        if [ -d "docs-output" ]; then
          cp -r docs-output/* ../docs-repo/generated/backend/
        fi
        
        # Create a simple index if DocFX failed
        if [ ! -f "../docs-repo/generated/backend/index.html" ]; then
          echo "# Backend API Documentation" > ../docs-repo/generated/backend/README.md
          echo "Documentation gÃ©nÃ©rÃ©e automatiquement le $(date)" >> ../docs-repo/generated/backend/README.md
        fi
        
        cd ..
        rm -rf temp-backend
        
    - name: ğŸ“š Generate FileServer Documentation
      if: contains(github.event.inputs.projects, 'fileserver') || contains(github.event.inputs.projects, 'all') || github.event_name == 'repository_dispatch'
      run: |
        # Clone fileserver repo avec token pour accÃ¨s privÃ©
        git clone https://x-access-token:${{ secrets.DOCS_TOKEN }}@github.com/DevoirsiTech/devoirsitech-fileserver.git temp-fileserver
        cd temp-fileserver
        
        # Build project to generate XML docs
        dotnet restore
        dotnet build --configuration Release
        
        # Generate documentation with DocFX
        docfx docfx.json --serve false
        
        # Copy to docs repo
        mkdir -p ../docs-repo/generated/fileserver
        if [ -d "docs-output" ]; then
          cp -r docs-output/* ../docs-repo/generated/fileserver/
        fi
        
        # Create a simple index if DocFX failed
        if [ ! -f "../docs-repo/generated/fileserver/index.html" ]; then
          echo "# FileServer API Documentation" > ../docs-repo/generated/fileserver/README.md
          echo "Documentation gÃ©nÃ©rÃ©e automatiquement le $(date)" >> ../docs-repo/generated/fileserver/README.md
        fi
        
        cd ..
        rm -rf temp-fileserver
        
    - name: ğŸ“š Generate Frontend Documentation
      if: contains(github.event.inputs.projects, 'frontend') || contains(github.event.inputs.projects, 'all') || github.event_name == 'repository_dispatch'
      run: |
        # Clone frontend repo avec token pour accÃ¨s privÃ©
        git clone https://x-access-token:${{ secrets.DOCS_TOKEN }}@github.com/DevoirsiTech/devoirsitech-frontend.git temp-frontend
        cd temp-frontend
        
        # Install dependencies
        npm ci
        
        # Generate documentation with TypeDoc
        npm run docs:generate || echo "TypeDoc failed, creating fallback documentation"
        
        # Copy to docs repo
        mkdir -p ../docs-repo/generated/frontend
        if [ -d "docs-output" ] && [ "$(ls -A docs-output)" ]; then
          cp -r docs-output/* ../docs-repo/generated/frontend/
        else
          # Create fallback documentation
          echo "# Frontend Components Documentation" > ../docs-repo/generated/frontend/README.md
          echo "" >> ../docs-repo/generated/frontend/README.md
          echo "Documentation gÃ©nÃ©rÃ©e automatiquement le $(date)" >> ../docs-repo/generated/frontend/README.md
          echo "" >> ../docs-repo/generated/frontend/README.md
          echo "## Fichiers principaux" >> ../docs-repo/generated/frontend/README.md
          echo "" >> ../docs-repo/generated/frontend/README.md
          echo "- \`src/main.tsx\` - Point d'entrÃ©e de l'application" >> ../docs-repo/generated/frontend/README.md
          echo "- \`src/App.tsx\` - Composant principal" >> ../docs-repo/generated/frontend/README.md
          echo "- \`src/config/api.ts\` - Configuration de l'API" >> ../docs-repo/generated/frontend/README.md
        fi
        
        cd ..
        rm -rf temp-frontend
        
    - name: ğŸ—ï¸ Update Main Documentation Site
      run: |
        cd docs-repo
        
        # Create/Update main index page
        cat > index.md << 'EOF'
        # ğŸ“š DiversiTech Documentation
        
        > **Documentation complÃ¨te** de la plateforme Ã©ducative DiversiTech (repos privÃ©s).
        
        ## ğŸ¯ Documentation Auto-gÃ©nÃ©rÃ©e
        
        ### APIs (.NET)
        - [ğŸ“‹ **Backend API**](generated/backend/) - Documentation de l'API Backend
        - [ğŸ“ **FileServer API**](generated/fileserver/) - Documentation de l'API FileServer  
        
        ### Frontend (React/TypeScript)
        - [ğŸŒ **Frontend Components**](generated/frontend/) - Documentation des composants React
        
        ## ğŸ“– Guides Manuels
        
        - [ğŸš€ Guide d'Installation](SETUP-GUIDE.md)
        - [ğŸ—ï¸ Architecture](ARCHITECTURE.md)
        - [ğŸ§ª Guide des Tests](TESTING-GUIDE.md)
        - [ğŸ”§ DevOps](CICD.md)
        
        ## ğŸ”„ DerniÃ¨re mise Ã  jour
        
        **Date :** TIMESTAMP_PLACEHOLDER
        
        **Projets documentÃ©s :**
        - âœ… Backend API (.NET 8)
        - âœ… FileServer API (.NET 8)
        - âœ… Frontend Components (React/TypeScript)
        
        ---
        
        *Cette documentation est automatiquement mise Ã  jour Ã  chaque commit sur les repos source.*
        EOF
        
        # Update timestamp
        sed -i "s/TIMESTAMP_PLACEHOLDER/$(date '+%Y-%m-%d %H:%M:%S UTC')/g" index.md
        
        # Create a summary of what was generated
        echo "" >> index.md
        echo "## ğŸ“Š Statut de gÃ©nÃ©ration" >> index.md
        echo "" >> index.md
        
        if [ -d "generated/backend" ]; then
          echo "- âœ… **Backend** : Documentation gÃ©nÃ©rÃ©e avec succÃ¨s" >> index.md
        else
          echo "- âŒ **Backend** : Ã‰chec de gÃ©nÃ©ration" >> index.md
        fi
        
        if [ -d "generated/fileserver" ]; then
          echo "- âœ… **FileServer** : Documentation gÃ©nÃ©rÃ©e avec succÃ¨s" >> index.md
        else
          echo "- âŒ **FileServer** : Ã‰chec de gÃ©nÃ©ration" >> index.md
        fi
        
        if [ -d "generated/frontend" ]; then
          echo "- âœ… **Frontend** : Documentation gÃ©nÃ©rÃ©e avec succÃ¨s" >> index.md
        else
          echo "- âŒ **Frontend** : Ã‰chec de gÃ©nÃ©ration" >> index.md
        fi
        
    - name: ğŸ“ Commit and push documentation
      run: |
        cd docs-repo
        git config user.name 'Documentation Bot'
        git config user.email 'noreply@devoirsitech.com'
        
        git add .
        
        if git diff --staged --quiet; then
          echo "âœ… Aucun changement Ã  commiter"
        else
          git commit -m "ğŸ“š Auto-update documentation - $(date '+%Y-%m-%d %H:%M:%S')"
          git pull --rebase origin main || true
          git push
          echo "âœ… Documentation mise Ã  jour et pushÃ©e vers devoirsitech-doc"
        fi
